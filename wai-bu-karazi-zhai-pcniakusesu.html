
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon">
  <link rel="icon" href="/assets/favicon.png" type="image/x-icon">


  <link href="https://2lu3.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="2lu3の三日坊主日記 Atom">



 

<meta name="author" content="2lu3" />
<meta name="description" content="外出中のみVPS経由で自宅PCにアクセスするための方法について説明します" />
<meta name="keywords" content="ssh, ubuntu">


  <meta property="og:site_name" content="2lu3の三日坊主日記"/>
  <meta property="og:title" content="外部から自宅PCにアクセス"/>
  <meta property="og:description" content="外出中のみVPS経由で自宅PCにアクセスするための方法について説明します"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./wai-bu-karazi-zhai-pcniakusesu.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-10-09 22:46:47+09:00"/>
  <meta property="article:modified_time" content="2022-10-09 23:00:26+09:00"/>
  <meta property="article:author" content="./author/2lu3.html">
  <meta property="article:section" content="開発環境"/>
  <meta property="article:tag" content="ssh"/>
  <meta property="article:tag" content="ubuntu"/>
  <meta property="og:image" content="/assets/sitelogo.png">

  <title>2lu3の三日坊主日記 &ndash; 外部から自宅PCにアクセス</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="/assets/sitelogo.png" alt="" title="">
    </a>

    <h1>
      <a href="./"></a>
    </h1>




    <ul class="social">
      <li>
        <a class="sc-twitter"
           href="https://twitter.com/hi2lu3"
           target="_blank">
          <i class="fa-brands fa-twitter"></i>
        </a>
      </li>
      <li>
        <a class="sc-github"
           href="https://github.com/2lu3"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>

<nav>
  <a href="./">Home</a>

  <a href="https://2lu3.github.io/archives.html">Archives</a>
  <a href="https://2lu3.github.io/categories.html">Categories</a>
  <a href="https://2lu3.github.io/tags.html">Tags</a>

  <a href="https://2lu3.github.io/feeds/all.atom.xml">Atom</a>

</nav>

<article class="single">
  <header>
      
    <h1 id="wai-bu-karazi-zhai-pcniakusesu">外部から自宅PCにアクセス</h1>
    <p>
      Posted on 日 09 10月 2022 in <a href="./category/kai-fa-huan-jing.html">開発環境</a>

    </p>
  </header>


  <div>
    <h1>はじめに</h1>
<p>本記事に書いてある手順を実行することは大きなセキュリティリスクになりえます。
セキュリティに関する記事を読み漁りながら安全な方法を見つけたつもりですが、私が知らないセキュリティホールがあるかもしれません。
そのため、この記事を読んだ結果起こったいかなることも責任を負いかねます。つまり、自己責任でお願いします。</p>
<h1>環境</h1>
<h2>自宅PC</h2>
<p>Ubuntu 22.04</p>
<h2>VPS</h2>
<p>Ubuntu 22.04</p>
<h1>事前準備</h1>
<p>自宅PCに開けるポート：<code>HOME_PORT</code>
VPSに開けるポート：<code>VPS_PORT</code>
VPSのIPアドレス：<code>VPS_IP</code></p>
<p>とします。</p>
<p>例えば、<code>HOME_PORT</code> = 54321のようになります。</p>
<p>このうち、<code>HOME_PORT</code>と<code>VPS_PORT</code>はシステムポート以外(=1024~65535)で好きな番号を設定してください。</p>
<p>そして、自宅PCで、<code>~/.remotessh</code>を作成して、以下のように書き込んでください。</p>
<div class="highlight"><pre><span></span><code>SSH_VPS_PORT=VPS_PORT
SSH_HOME_PORT=HOME_PORT
SSH_VPS_NAME=VPS_IP
</code></pre></div>

<h1>VPS側での作業</h1>
<p>VPSにsshできる前提で話を進めます。
もし、oepnssh serverがない場合は、自宅PCと同様の作業を行ってください。ただし、<code>HOME_PORT</code>の代わりに、<code>VPS_PORT</code>を使う必要があります。</p>
<h2>公開鍵暗号の作成</h2>
<div class="highlight"><pre><span></span><code>ssh-keygen -t ed25519 -C <span class="s2">&quot;vps&quot;</span>
</code></pre></div>

<p>と実行し、<code>~/.ssh/id_ed25519.pub</code>の内容をコピーしてください。</p>
<h2>configファイルの作成</h2>
<p><code>~/.ssh/config</code>ファイルを作成し、以下のように設定してください。</p>
<div class="highlight"><pre><span></span><code>Host 好きな名前
    HostName localhost
    User 自宅PCのユーザー名
    Port VPS_PORT
    ForwardX11 yes # x11 forwardingできるようになる
    ServerAliveInterval 60 # ずっと放置してても繋がり続ける
    IdentityFile ~/.ssh/id_ed25519
</code></pre></div>

<h1>自宅PCでの作業</h1>
<h2>oepnssh serverを建てる</h2>
<div class="highlight"><pre><span></span><code>sudo apt install openssh-server
</code></pre></div>

<div class="highlight"><pre><span></span><code>sudo vi /etc/ssh/sshd_config
</code></pre></div>

<p>として、</p>
<div class="highlight"><pre><span></span><code># 変更前
# PORT 22

# 変更後
Port HOME_PORT
</code></pre></div>

<p>のように編集してください。</p>
<p>その後、下のコマンドを実行してopenssh serverを再起動してください。</p>
<div class="highlight"><pre><span></span><code>sudo systemctl restart sshd
</code></pre></div>

<h2><code>HOME_PORT</code> を開ける</h2>
<div class="highlight"><pre><span></span><code>sudo apt install -y ufw

sudo ufw <span class="nb">enable</span>
sudo ufw allow HOME_PORT
</code></pre></div>

<p>上のように実行することで、HOME_PORTへのアクセスを許可するように設定します。</p>
<p>TODO: VPSのIPアドレスからのみ許可する</p>
<h2>VPSの公開鍵を登録する</h2>
<p>先ほどコピーした <code>~/.ssh/id_ed25519.pub</code>の内容を、<code>~/.ssh/authorized_keys</code>の中に貼り付け、保存してください。</p>
<h1>実際に接続する</h1>
<div class="highlight"><pre><span></span><code>ssh -NR VPS_PORT:localhost:HOME_PORT VPS_IP
</code></pre></div>

<p>上のコマンドを使うことで、<a href="https://qiita.com/mechamogera/items/b1bb9130273deb9426f5">リモートフォワード</a>をつなげます。
その結果、VPSのVPS_PORTにアクセスすると、自宅PCのHOME_PORTにアクセスできます。
何も出力されないはずですが、そのまま置いておいてください。</p>
<p>では、</p>
<ol>
<li>自宅PC→VPSにssh</li>
<li>VPS→自宅PCにssh</li>
</ol>
<p>して、VPSから自宅PCにsshできることを確かめましょう。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># VPSにsshする</span>
ssh VPS_IP

<span class="c1"># ここはVPSの中にいる状態です</span>
ssh 上で書いた好きな名前
</code></pre></div>

<p>うまく行っていれば、上の2行のコマンドを実行するだけで自宅PCにsshできます。</p>
<h1>リモートフォワードをserviceとして登録する</h1>
<p><code>~/.config/systemd/user/remotessh.service</code>というファイルを作成し、下の内容を書き込んでください。</p>
<div class="highlight"><pre><span></span><code><span class="k">[Unit]</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">&quot;外部からssh&quot;</span><span class="w"></span>

<span class="k">[Service]</span><span class="w"></span>
<span class="na">EnvironmentFile</span><span class="o">=</span><span class="s">/home/ユーザー名/.remotessh</span><span class="w"></span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">ssh -NR ${SSH_VPS_PORT}:localhost:${SSH_HOME_PORT} ${SSH_VPS_NAME}</span><span class="w"></span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/bin/kill ${MAINPID}</span><span class="w"></span>

<span class="k">[Install]</span><span class="w"></span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">defalt.target</span><span class="w"></span>
</code></pre></div>

<p>これにより、<code>systemctl --user start remotessh.service</code>と実行すればVPSから自宅PCにアクセスできるようになり、<code>systemctl --user stop remotessh.service</code>と実行すればアクセスできないようになります。</p>
<h1>参考記事</h1>
<p><a href="https://frute.hatenablog.com/entry/2018/11/19/003056">ubuntu自宅サーバにsshで外部からアクセス - 勇往邁進</a></p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/ssh.html">ssh</a>
      <a href="./tag/ubuntu.html">ubuntu</a>
    </p>
  </div>



  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./zoterodelun-wen-wowebdavnibao-cun-suru.html">zoteroで論文をwebdavに保存する</a></li>
      <li><a href="./ubuntudemaususu-du-wozi-dong-she-ding.html">ubuntuでマウス速度を自動設定</a></li>
    </ul>
  </div>



</article>

<footer>
<p>&copy;  </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " 2lu3の三日坊主日記 ",
  "url" : ".",
  "image": "/assets/sitelogo.png",
  "description": ""
}
</script>
</body>
</html>